/*! data-transfer 20.01.2017 */
angular.module("data-transfer",["ui.bootstrap","ngResource","templates-dataTransfer"]),angular.module("data-transfer").factory("browserDetectionService",function(){return{getBrowserInfo:function(){var a,b,c,d=(navigator.appVersion,navigator.userAgent),e=navigator.appName,f=""+parseFloat(navigator.appVersion),g=parseInt(navigator.appVersion,10);-1!=(b=d.indexOf("OPR/"))?(e="Opera",f=d.substring(b+4)):-1!=(b=d.indexOf("Opera"))?(e="Opera",f=d.substring(b+6),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("MSIE"))?(e="Microsoft Internet Explorer",f=d.substring(b+5)):-1!=(b=d.indexOf("Chrome"))?(e="Chrome",f=d.substring(b+7)):-1!=(b=d.indexOf("Safari"))?(e="Safari",f=d.substring(b+7),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("Firefox"))?(e="Firefox",f=d.substring(b+8)):(a=d.lastIndexOf(" ")+1)<(b=d.lastIndexOf("/"))&&(e=d.substring(a,b),f=d.substring(b+1),e.toLowerCase()==e.toUpperCase()&&(e=navigator.appName)),-1!=(c=f.indexOf(";"))&&(f=f.substring(0,c)),-1!=(c=f.indexOf(" "))&&(f=f.substring(0,c)),g=parseInt(""+f,10),isNaN(g)&&(f=""+parseFloat(navigator.appVersion),g=parseInt(navigator.appVersion,10));var h=detectWebKit();return{hasWebkit:h.iswebkit,webkitVersion:this.hasWebkit?parseFloat(h.version):null,name:e,version:g}}}}),angular.module("data-transfer").factory("configService",function(){var a;return $.ajax({url:"/dataTransfer/settings.json",async:!1,dataType:"json",success:function(b){a=b}}),{getAutoStart:function(){return a.autoStart},getAutoRetriesQty:function(){return a.autoRetriesQty},getConcurentTransfersQty:function(){return a.concurentTransfersQty},getApiEndpointURL:function(){return a.apiEndpointURL},getDisplayedTransfersQty:function(){return a.displayedTransfersQty}}}),angular.module("data-transfer").factory("mockService",["$timeout",function(a){var b=[];return{uploadFile:function(a){b.push(a),b[b.length-1].status="Queued";var c,d=a.prog;c=void 0!==a.time?a.time:0;var e,f,g=!1,h=!1,i=$.Event("progress"),j=$.Event("complete"),k=setInterval(function(){var l=b.lastIndexOf(a);-1!==l&&(("Failed"===b[l].status||"Queued"===b[l].status)&&(b[l].status="Pending"),"Queued"===b[l].status&&(c=0),"Pending"===b[l].status&&(c+=100),d=c/e*100,i.prog=d,i.file=a,i.elapsedTime=c/1e3+" s",i.time=c,g=c>e,i.remainingTime=(e-c)/1e3+" s",i.state=b[l].status,g?h||(j.state=f,j.file=a,j.service="mock",l=b.indexOf(a),b.splice(l,1),h=!0,clearInterval(k),$(window).trigger(j)):$(window).trigger(i))},100);-1!==a.name.indexOf("success")?(e=2e3,f="Succeeded"):-1!==a.name.indexOf("error")?(e=3e3,f="Failed"):(e=5e3,f="Failed")},pause:function(a){var c=b.indexOf(a);b[c].status="Paused"},resume:function(a){var c=b.indexOf(a);-1!==c?b[c].status="Pending":(a.status="Pending",this.uploadFile(a))},stop:function(a){var c=b.indexOf(a);-1!==c?b[c].status="Queued":(a.status="Queued",a.time=0,a.prog=0,a.elapsedTime="",a.remainingTime="")}}}]),angular.module("data-transfer").factory("serviceFactory",["uploadService","mockService",function(a,b){return{getService:function(c){var d={};switch(c){case"mock":d=b;break;case"upload":d=a;break;default:d=b}return d}}}]),angular.module("data-transfer").factory("transfersService",["serviceFactory","configService",function(a,b){var c=[],d=[],e=$.Event("filePushed"),f=a.getService("upload"),g=[],h=b.getConcurentTransfersQty(),i=0,j=$.Event("run");return j.state="Pending",$(window).on("complete",function(a){var e=transfers.indexOf(a.file);g.splice(e,1);var k=h-1;"Succeeded"==a.state?(i++,i<c.length-k&&b.getAutoStart()&&(g.push(c[i+k]),f.uploadFile(c[i+k]),j.file=c[i+k],$(window).trigger(j))):"Failed"==a.state&&(d[e]<b.getAutoRetriesQty()?(f.uploadFile(a.file),j.file=a.file,$(window).trigger(j),d[e]++):(i++,b.getAutoStart()&&i+k<c.length&&(f.uploadFile(c[i+k]),j.file=c[i+k],$(window).trigger(j))))}),{pushFile:function(a){c.push(a),d.push(0),e.status=b.getAutoStart()?"Pending":"Queued",e.file=a,$(window).trigger(e),b.getAutoStart()&&this.start(a)},getFiles:function(){return c},removeFile:function(a){var b=c.indexOf(a);c.splice(b,1);var d=$.Event("remove");d.file=a,$(window).trigger(d)},start:function(a){g.length<h&&(g.push(a),f.uploadFile(a),j.file=a,$(window).trigger(j))},getRunningTransfers:function(){return g}}}]),angular.module("data-transfer").factory("uploadService",["$http","$resource","configService",function(a,b,c){var d=c.getApiEndpointURL();return{uploadFile:function(b){var c=new FormData;c.append("file",b),a.post(d,c,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(a){var c=$.Event("complete");c.file=b,c.state="Succeeded",$(window).trigger(c)}).error(function(a){var c=$.Event("complete");c.file=b,c.state="Failed",$(window).trigger(c)})}}}]),angular.module("data-transfer").directive("dtDropZone",function(){return{restrict:"E",templateUrl:"js/Directives/templates/dropZone.tpl.html"}}),angular.module("data-transfer").directive("dtTransfersView",function(){return{restrict:"E",scope:{page:"="},templateUrl:"js/Directives/templates/transfersView.tpl.html"}}),angular.module("data-transfer").controller("dropController",["$scope","browserDetectionService","transfersService",function(a,b,c){function d(a){for(var b={lastModified:a.lastModified,lastModifiedDate:a.lastModifiedDate,name:a.name,size:a.size,type:a.type},d=!1,e=CryptoJS.MD5(JSON.stringify(b)),f=0;f<h.length;f++)d=JSON.stringify(h[f])===JSON.stringify(e),d&&(f=h.length,alert("File already dropped: "+a.name));d||(h.push(e),g.push(a),c.pushFile(a))}var e=b.getBrowserInfo(),f=e.hasWebkit,g=[],h=[];f?document.getElementById("dropMessage").innerHTML="Drag n'drop your files or folders here":document.getElementById("dropMessage").innerHTML="Drag n'drop your files here";var i=document.getElementById("dropZone");i.ondragover=function(a){a.preventDefault()},i.ondrop=function(b){b.preventDefault();for(var e=f?b.dataTransfer.items:b.dataTransfer.files,h=0;h<e.length;h++)if(f){var i=e[h].webkitGetAsEntry();i.isDirectory?a.scanDirectory(i):i.isFile&&i.file(d)}else g.push(e[h]),c.pushFile(e[h])},a.scanDirectory=function(b){var c=b.createReader();c.readEntries(function(b){b.forEach(function(b){b.isDirectory?a.scanDirectory(b):b.isFile&&b.file(d)})})}}]),angular.module("data-transfer").controller("viewController",["$scope","configService","transfersService",function(a,b,c){var d=[],e=[],f=[];a.displayedTransfers=[],a.selectedTransfers=[];var g=1;a.allSelected=!1,$(window).on("filePushed",function(b){d.push(b.file),f=c.getRunningTransfers();for(var h="Queued",i=0;i<f.length;i++)f[i].name==b.file.name&&(h="Pending",i=f.length);var j={name:b.file.name,size:b.file.size,displaySize:function(){for(var a=0,b=this.size;b>1024;)b/=1024,a++;return Number(b.toFixed(0))+(2==a?" MB":1==a?" KB":" B")},status:h,transferType:"Upload"};e.push(j),a.displayedTransfers.push(j),a.definePagination(),a.changePage(g),a.$apply()}),$(window).on("remove",function(b){var c=d.indexOf(b.file);d.splice(c,1),e.splice(c,1),a.definePagination(),a.changePage(g)}),$(window).on("run",function(a){var b=d.indexOf(a.file);e[b].status=a.state}),$(window).on("progress",function(b){var c=d.indexOf(b.file);e[c].elapsedTime=b.elapsedTime,e[c].remainingTime=b.remainingTime,a.$apply()}),$(window).on("complete",function(b){var c=d.indexOf(b.file);e[c].status=b.state,"mock"===b.service&&a.$apply()}),a["delete"]=function(){for(var b=0;b<a.displayedTransfers.length;b++)a.displayedTransfers[b].selected&&(c.removeFile(d[b]),a.selectedTransfers.splice(b,1))},a.toggleAll=function(){if(0===a.selectedTransfers.length)for(var b=0;b<c.getFiles().length;b++)a.selectedTransfers.push(a.displayedTransfers[b]),a.displayedTransfers[b].selected=!0,a.allSelected=!0;else{a.selectedTransfers=[];for(var d=0;d<a.displayedTransfers.length;d++)a.displayedTransfers[d].selected=!1,a.allSelected=!1}},a.toggleSelected=function(b){var c=a.selectedTransfers.indexOf(b);-1===c?a.selectedTransfers.push(b):a.selectedTransfers.splice(c,1),a.allSelected=a.selectedTransfers.length>0},a.start=function(a){var b=e.indexOf(a);c.start(d[b])},a.changePage=function(c){0!==c&&(g=c),a.displayedTransfers=[];var d=b.getDisplayedTransfersQty();transfers=e;for(var f=0,h=5*(g-1);d>f;f++,h++)void 0!==transfers[h]?"upload"!=a.page||"Upload"==transfers[h].transferType?a.displayedTransfers.push(transfers[h]):f--:f=d},a.definePagination=function(){var c=b.getDisplayedTransfersQty();a.pageCount=e.length/c+1,$("#page-selection").bootpag({total:a.pageCount,maxVisible:c,firstLastUse:!0,first:"←",last:"→"}).on("page",function(b,c){a.changePage(c),a.$apply()}),"upload"!=a.page&&a.defineBodyPadding()},a.defineBodyPadding=function(){var a=$("body");a.css("padding-bottom",h.css("height"))};var h=$("#fileTransfersView"),i=$("#imgChevronCollapse");i.on("click",function(){i.hasClass("fa-chevron-down")?(i.removeClass("fa-chevron-down"),i.addClass("fa-chevron-up")):i.hasClass("fa-chevron-up")&&(i.removeClass("fa-chevron-up"),i.addClass("fa-chevron-down"))}),h.on("hidden.bs.collapse",function(){"upload"!=a.page&&a.defineBodyPadding()}),h.on("shown.bs.collapse",function(){"upload"!=a.page&&a.defineBodyPadding()}),a.$on("ngRepeatFinished",function(b){"upload"!=a.page&&a.defineBodyPadding()})}]).directive("onFinishRender",function(a){return{restrict:"A",link:function(b,c,d){b.$last===!0&&a(function(){b.$emit(d.onFinishRender)})}}});