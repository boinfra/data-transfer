/*! data-transfer 21.02.2017 */
angular.module("dt-download",[]).service("downloadService",["configService",function(a){var b=[];return{download:function(c,d,e,f){var g=0;window.setInterval(function(){g+=100},100);var h=new XMLHttpRequest;h.aborted=!1,h.open("GET",d),h.responseType="blob",h.onprogress=function(a){var b=a.loaded/a.total*100;f(b,a.loaded,g,a.total,c)},h.onloadend=function(){if(4===h.readyState&&!h.aborted){var d="",f="";if(h.status<400){var g=!1;g="application/zip"===h.response.type,saveAs(h.response,g?c+".zip":c),d="Succeeded",e(c,d,f)}else{d="Failed";var i=new FileReader;i.onloadend=function(){if(h.getResponseHeader("Content-Type").indexOf("application/json")>-1)f=JSON.parse(i.result)[a.getApiErrorMessageName()];else if(h.getResponseHeader("Content-Type").indexOf("text/xml")>-1){var b=new DOMParser;xml=b.parseFromString(i.result,"text/xml"),f=xml.getElementsByTagName(a.getApiErrorMessageName())[0].childNodes[0].nodeValue}e(c,d,f)},i.readAsText(h.response)}b.splice(b.indexOf(h),1)}},b.push(h),h.send()},stop:function(a,c,d){b[a].aborted=!0,b[a].abort(),b.splice(a,1),d(c)}}}]);var dtUpload=dtUpload||angular.module("dt-upload",[]);dtUpload.controller("dropController",["browserDetectionService","transfersService","configService",function(a,b,c){function d(a){for(var d={lastModified:a.lastModified,lastModifiedDate:a.lastModifiedDate,name:a.name,size:a.size,type:a.type},e=!1,f=CryptoJS.MD5(JSON.stringify(d)),g=0;g<h.length;g++)e=JSON.stringify(h[g].hash)===JSON.stringify(f),e&&(g=h.length,alert("File already dropped: "+a.name));if(!e){h.push({hash:f,filename:a.name});var i=$.Event("dropped");i.file=a,i.status=c.getAutoStart()?"Pending":"Queued",$(window).trigger(i),c.getAutoStart()&&b.uploadFile(a)}}function e(a){var b=a.createReader();b.readEntries(function(a){a.forEach(function(a){a.isDirectory?e(a):a.isFile&&a.file(d)})})}var f=a.getBrowserInfo(),g=f.hasWebkit;g?document.getElementById("dropMessage").innerHTML="Drag n'drop your files or folders here":document.getElementById("dropMessage").innerHTML="Drag n'drop your files here";var h=[],i=document.getElementById("dropZone");i.ondragover=function(a){a.preventDefault()},i.ondrop=function(a){a.preventDefault();for(var b=g?a.dataTransfer.items:a.dataTransfer.files,c=0;c<b.length;c++)if(g){var f=b[c].webkitGetAsEntry();f.isDirectory?e(f):f.isFile&&f.file(d)}else d(b[c])},$(window).on("removed",function(a){var b=h.indexOf(h.filter(function(b){return b.filename===a.filename})[0]);b>-1&&h.splice(b,1)})}]);var dtUpload=dtUpload||angular.module("dt-upload",[]);dtUpload.directive("dtDropZone",function(){return{restrict:"E",templateUrl:"js/dt-upload/dropZone.tpl.html"}});var dtUpload=dtUpload||angular.module("dt-upload",[]);dtUpload.service("uploadService",["configService",function(a){var b=[];return{uploadFile:function(c,d,e){var f=new FormData;f.append("file",c);var g=0;window.setInterval(function(){g+=100},100);var h=new XMLHttpRequest;h.aborted=!1,h.open("POST",a.getUploadURL()),h.upload.onprogress=function(a){var b=a.loaded/a.total*100;e(b,a.loaded,g,a.total,c.name)},h.onloadend=function(){if(4===h.readyState&&!h.aborted){var e=h.status<400?"Succeeded":"Failed";b.splice(b.indexOf(h),1);var f="";h.status>=400&&(h.getResponseHeader("Content-Type").indexOf("application/json")>-1?f=JSON.parse(h.response)[a.getApiErrorMessageName()]:h.getResponseHeader("Content-Type").indexOf("text/xml")>-1&&(f=$(h.responseXML).find(a.getApiErrorMessageName()).text())),d(c.name,e,f)}},b.push(h),h.send(f)},stop:function(a,c,d){b[a].aborted=!0,b[a].abort(),b.splice(a,1),d(c)}}}]);var dt=dt||angular.module("data-transfer",["dt-download","dt-upload","ui.bootstrap","templates-dataTransfer"]);dt.factory("browserDetectionService",function(){return{getBrowserInfo:function(){var a,b,c,d=(navigator.appVersion,navigator.userAgent),e=navigator.appName,f=""+parseFloat(navigator.appVersion),g=parseInt(navigator.appVersion,10);-1!=(b=d.indexOf("OPR/"))?(e="Opera",f=d.substring(b+4)):-1!=(b=d.indexOf("Opera"))?(e="Opera",f=d.substring(b+6),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("MSIE"))?(e="Microsoft Internet Explorer",f=d.substring(b+5)):-1!=(b=d.indexOf("Chrome"))?(e="Chrome",f=d.substring(b+7)):-1!=(b=d.indexOf("Safari"))?(e="Safari",f=d.substring(b+7),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("Firefox"))?(e="Firefox",f=d.substring(b+8)):(a=d.lastIndexOf(" ")+1)<(b=d.lastIndexOf("/"))&&(e=d.substring(a,b),f=d.substring(b+1),e.toLowerCase()==e.toUpperCase()&&(e=navigator.appName)),-1!=(c=f.indexOf(";"))&&(f=f.substring(0,c)),-1!=(c=f.indexOf(" "))&&(f=f.substring(0,c)),g=parseInt(""+f,10),isNaN(g)&&(f=""+parseFloat(navigator.appVersion),g=parseInt(navigator.appVersion,10));var h=detectWebKit();return{hasWebkit:h.iswebkit,webkitVersion:this.hasWebkit?parseFloat(h.version):null,name:e,version:g}}}});var dt=dt||angular.module("data-transfer",["dt-download","dt-upload","ui.bootstrap","templates-dataTransfer"]);dt.factory("configService",function(){var a;return $.ajax({url:"/dataTransfer/settings.json",async:!1,dataType:"json",success:function(b){a=b}}),{getAutoStart:function(){return a.autoStart},getAutoRetriesQty:function(){return a.autoRetriesQty},getConcurentTransfersQty:function(){return a.concurentTransfersQty},getUploadURL:function(){return a.baseURL+a.uploadURL},getFilesURL:function(){return a.baseURL+a.filesURL},getDisplayedTransfersQty:function(){return a.displayedTransfersQty},getApiErrorMessageName:function(){return a.apiErrorMessageName}}});var dt=dt||angular.module("data-transfer",["dt-download","dt-upload","ui.bootstrap","templates-dataTransfer"]);dt.directive("dtTransfersView",function(){return{restrict:"E",scope:{page:"="},templateUrl:"js/dataTransfer/transfersView.tpl.html"}});var dt=dt||angular.module("data-transfer",["dt-download","dt-upload","ui.bootstrap","templates-dataTransfer"]);dt.service("serviceFactory",["downloadService","uploadService",function(a,b){return{getService:function(c){return c.toLowerCase().indexOf("down")>-1?a:c.toLowerCase().indexOf("up")>-1?b:void 0}}}]);var dt=dt||angular.module("data-transfer",["dt-download","dt-upload","ui.bootstrap","templates-dataTransfer"]);dt.service("transfersService",["serviceFactory","configService",function(a,b){var c=a.getService("download"),d=a.getService("upload"),e=[],f=[],g=0;return{downloadFile:function(a,d){if(-1==e.indexOf(e.filter(function(b){return b.name===a&&b.url===d})[0])&&e.push({name:a,url:d,retries:0}),f.length<b.getConcurentTransfersQty()){f.push({name:a,url:d,retries:0});var h=this,i=$.Event("start");i.filename=a,i.url=d,i.transferType="Download",$(window).trigger(i),c.download(a,d,function(c,i,j){var k=$.Event("finished");k.filename=c,k.state=i,$(window).trigger(k);var l,m=e.filter(function(b){return b.name===a})[0];"Failed"===i?m.retries<b.getAutoRetriesQty()?(h.downloadFile(a,d),m.retries++):(void 0!==j&&alert(j),g++,l=f.indexOf(f.filter(function(a){return a.name===m.name})[0]),f.splice(l,1),l=g+b.getConcurentTransfersQty()-1,e.length>l&&h.downloadFile(e[l].name,e[l].url)):"Succeeded"===i&&(g++,l=f.indexOf(f.filter(function(a){return a.name===m.name})[0]),f.splice(l,1),l=g+b.getConcurentTransfersQty()-1,e.length>l&&h.downloadFile(e[l].name,e[l].url))},function(a,b,c,d,e){var f=$.Event("progress");f.prog=a,f.loaded=b,f.elapsedTime=c,f.size=d,f.filename=e,$(window).trigger(f)})}},uploadFile:function(a){if(-1==e.indexOf(e.filter(function(b){return b.name===a.name})[0])&&e.push({file:a,name:a.name,retries:0}),f.length<b.getConcurentTransfersQty()){f.push({file:a,name:a.name,retries:0});var c=this,h=$.Event("start");h.filename=a.name,h.transferType="Upload",$(window).trigger(h),d.uploadFile(a,function(d,h,i){var j=$.Event("finished");j.filename=d,j.state=h,$(window).trigger(j);var k,l=e.filter(function(b){return b.name===a.name})[0];"Failed"===h?l.retries<b.getAutoRetriesQty()?(c.uploadFile(a),l.retries++):(void 0!==i&&alert(i),g++,k=f.indexOf(f.filter(function(a){return a.name===l.name})[0]),f.splice(k,1),k=g+b.getConcurentTransfersQty()-1,e.length>k&&c.uploadFile(e[k].file)):"Succeeded"===h&&(g++,k=f.indexOf(f.filter(function(a){return a.name===l.name})[0]),f.splice(k,1),k=g+b.getConcurentTransfersQty()-1,e.length>k&&c.uploadFile(e[k].file))},function(a,b,c,d,e){var f=$.Event("progress");f.prog=a,f.loaded=b,f.elapsedTime=c,f.size=d,f.filename=e,$(window).trigger(f)})}},stop:function(a,b,e){var g=f.indexOf(f.filter(function(a){return a.name===b.name})[0]);f.splice(g,1),"Download"===a?c.stop(g,b,function(a){e(a)}):"Upload"===a&&d.stop(g,b,function(a){e(a)})}}}]);var dt=dt||angular.module("data-transfer",["dt-download","dt-upload","ui.bootstrap","templates-dataTransfer"]);dt.controller("viewController",["$scope","configService","transfersService",function(a,b,c){var d=[],e=[],f=1;a.displayedTransfers=[],a.selectedTransfers=[],a.failedTransfers=[],a.areTransfersRunning=!1,window.onload=function(){a.defineBodyPadding()},$(window).on("start",function(b){var c={selected:!1,name:b.filename,downloadUrl:b.url,transferType:b.transferType,status:"Pending",prog:0,aborted:!1};-1===d.indexOf(d.filter(function(a){return a.name===b.filename&&a.transferType===b.transferType})[0])&&d.push(c),a.definePagination()}),$(window).on("finished",function(b){var c=d.filter(function(a){return a.name===b.filename})[0];c.status=b.state,a.areTransfersRunning=d.filter(function(a){return"Pending"===a.status}).length>0,"Failed"===b.state&&-1===a.failedTransfers.indexOf(c)&&a.failedTransfers.push(c),a.$apply()}),$(window).on("progress",function(b){var c=d.filter(function(a){return a.name===b.filename})[0];c.status="Pending",c.prog=Math.floor(b.prog),c.displaySize=function(){for(var a=0,c=b.size;c>1024;)c/=1024,a++;return Number(c.toFixed(0))+(2==a?" MB":1==a?" KB":" B")},c.elapsedTime=b.elapsedTime/1e3,c.speed=b.loaded/b.elapsedTime/1024,c.remainingTime=b.elapsedTime/b.prog*(100-b.prog)/1e3,c.aborted||a.$apply()}),$(window).on("dropped",function(b){var c={selected:!1,name:b.file.name,transferType:"Upload",status:"Queued",prog:0,aborted:!1,size:b.file.size,displaySize:function(){for(var a=0,b=this.size;b>1024;)b/=1024,a++;return Number(b.toFixed(0))+(2==a?" MB":1==a?" KB":" B")}};d.push(c),e.push(b.file),a.definePagination(),a.$apply()}),a.start=function(a){a.aborted=!1;var b=d.indexOf(a);"Upload"===a.transferType?c.uploadFile(e[b]):"Download"===a.transferType&&c.downloadFile(a.name,a.downloadUrl)},a["delete"]=function(){a.selectedTransfers.forEach(function(a){var b=d.indexOf(a);d.splice(b,1),e.splice(b,1);var c=$.Event("removed");c.filename=a.name,$(window).trigger(c)}),a.selectedTransfers=[],a.failedTransfers=d.filter(function(a){return"Failed"===a.status}),a.definePagination()},a.retryFailed=function(){a.failedTransfers.forEach(function(b){a.start(b)})},a.toggleAll=function(){a.selectedTransfers.length===a.displayedTransfers.length?a.displayedTransfers.forEach(function(b){b.selected&&a.toggle(b)}):a.displayedTransfers.forEach(function(b){b.selected||a.toggle(b)}),a.selectedTransfers=a.displayedTransfers.filter(function(a){return a.selected})},a.startSelected=function(){a.selectedTransfers.forEach(function(b){a.start(b)})},a.stop=function(a){a.aborted=!0,c.stop(a.transferType,a,function(a){var b=d[d.indexOf(a)];b.speed=0,b.elapsedTime=0,b.prog=0,b.remainingTime=0,b.status="Queued"})},a.toggle=function(b){b.selected=!b.selected,a.selectedTransfers=a.displayedTransfers.filter(function(a){return a.selected})},a.changePage=function(c){0!==c&&(f=c),a.displayedTransfers=[];var e=b.getDisplayedTransfersQty();transfers=d;for(var g=0,h=5*(f-1);e>g;g++,h++)void 0!==transfers[h]?"upload"!=a.page||"Upload"==transfers[h].transferType?a.displayedTransfers.push(transfers[h]):g--:g=e},a.definePagination=function(){var c=b.getDisplayedTransfersQty();a.pageCount=d.length/c+1,$("#page-selection").bootpag({total:a.pageCount,maxVisible:c,firstLastUse:!0,first:"←",last:"→"}).on("page",function(b,c){a.changePage(c),a.$apply()}),"upload"!=a.page&&a.defineBodyPadding(),a.changePage(f)},a.defineBodyPadding=function(){var a=$("body");a.css("padding-bottom",g.css("height"))};var g=$("#fileTransfersView"),h=$("#imgChevronCollapse");h.on("click",function(){h.hasClass("fa-chevron-down")?(h.removeClass("fa-chevron-down"),h.addClass("fa-chevron-up")):h.hasClass("fa-chevron-up")&&(h.removeClass("fa-chevron-up"),h.addClass("fa-chevron-down"))}),g.on("hidden.bs.collapse",function(){"upload"!=a.page&&a.defineBodyPadding()}),g.on("shown.bs.collapse",function(){"upload"!=a.page&&a.defineBodyPadding()}),a.$on("ngRepeatFinished",function(b){"upload"!=a.page&&a.defineBodyPadding()})}]).directive("onFinishRender",function(a){return{restrict:"A",link:function(b,c,d){b.$last===!0&&a(function(){b.$emit(d.onFinishRender)})}}});